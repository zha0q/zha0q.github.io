---
title: vite
author: zq
date: 2023-02-27
category: md
layout: post
---



##### Esbuild
0. ä½¿ç”¨goå¼€å‘çš„Esbuildå¦‚ä½•ä½œä¸ºnpmåŒ…è¿è¡Œï¼Ÿä¸ºä»€ä¹ˆæ¯”å…¶ä»–jså¼€å‘çš„å¿«
go è¯­è¨€ç¼–è¯‘æˆäºŒè¿›åˆ¶æ–‡ä»¶ç›´æ¥æ‰§è¡Œï¼ŒEsbuild çš„ npm åŒ…åªæ˜¯å†™äº†å±‚èƒ¶æ°´ä»£ç ï¼Œå¯åŠ¨å­è¿›ç¨‹è¿è¡Œè¿™ä¸ªäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œæœ¬è´¨ä¸Šæ¯”å…¶å®ƒåªç”¨ js çš„åŒ…è¦å¿«

1. Vite ä¸­çš„ä¾èµ–é¢„æ„å»ºæŠ€æœ¯ä¸»è¦è§£å†³äº† 2 ä¸ªé—®é¢˜ï¼Œå³æ¨¡å—æ ¼å¼å…¼å®¹é—®é¢˜(ESM)å’Œæµ·é‡æ¨¡å—è¯·æ±‚çš„é—®é¢˜ã€‚è‡ªåŠ¨æ„å»ºæ ¹ç›®å½•ä¸‹çš„node_modulesä¸­.viteç›®å½•ï¼Œè¿™å°±æ˜¯é¢„æ„å»ºäº§ç‰©æ–‡ä»¶å­˜æ”¾çš„ç›®å½•ã€‚ä¾èµ–é¢„æ„å»ºé€šè¿‡Esbuildå°†ä¾èµ–è¿›è¡Œæ‰“åŒ…å¹¶è½¬ä¸ºESMæ ¼å¼

2. åœ¨ä¾èµ–é¢„æ„å»ºé˜¶æ®µï¼Œesbuildä½œä¸ºBundlerè¿›è¡Œæ‰“åŒ…ï¼Œåœ¨jsx/tsxç¼–è¯‘é˜¶æ®µé€šè¿‡viteæ’ä»¶æ¥æä¾›æ˜¯ä½¿ç”¨esbuildè¿›è¡Œè¯­æ³•è½¬è¯‘çš„åŠŸèƒ½ï¼Œç”¨æ¥æ›¿æ¢babel/tsc

3. ä»£ç å‹ç¼©ï¼Œç”±äºå…¶ASTå…±äº«ä»¥åŠåŸç”Ÿè¯­è¨€ç¼–å†™å¯¹CPUå¯†é›†å‹çš„ä»»åŠ¡æ”¯æŒè¿œå¼ºäºTerser

##### Rollup
1. cssä»£ç åˆ†å‰²ï¼Œå¼‚æ­¥å¼•å…¥cssä»£ç æ—¶è‡ªåŠ¨æŠ½å–ä¸ºå•ç‹¬æ–‡ä»¶ï¼Œæé«˜ç¼“å­˜å¤ç”¨ç‡
2. ä¸ºå…¥å£chunkä¾èµ–è‡ªåŠ¨é¢„åŠ è½½
3. å¼‚æ­¥ChunkåŠ è½½ä¼˜åŒ–ï¼Œæé«˜ä¾èµ–åŠ è½½

##### ç¼–å†™Esbuildæ’ä»¶
1. Build API
``` javascript
async function runBuild() {
  build({
    absWorkingDir: process.cwd(),
    entryPoints: ["../src/index.tsx"],
    outdir: "../dist",
    bundle: true,
    format: "esm",
    splitting: true,
    sourcemap: true,
    metafile: true,
    plugins: [httpImport(), htmlPlugin()],
  }).then(() => {
    console.log("ğŸš€ Build Finished!");
  });
}
```
2. Transform API
``` javascript
setup(build) {
let https = require("https");
let http = require("http");

    // è·¯å¾„è§£ææ‹¦æˆªé—´æ¥ä¾èµ–
    build.onResolve({
        filter: /.*/,
        namespace: 'http-url'
    }, (args) => ({
        path: new URL(args.path, args.importer).toString(),
        namespace: 'http-url'
    }));
}
```

##### Rollupæ‰“åŒ…åŸºæœ¬æ¦‚å¿µåŠå¸¸ç”¨é…ç½®
1. rollupè‡ªå¸¦TreeShaking
2. å¤šäº§ç‰©é…ç½®
``` javascript
output: [
    {
      dir: "dist/es",
      format: "esm",
    },
    {
      dir: "dist/cjs",
      format: "cjs",
    },
  ],
```
3. å¤šå…¥å£é…ç½®
``` javascript
// å¯¼å‡ºé…ç½®æ•°ç»„ï¼Œä¸åŒå…¥å£ä½¿ç”¨ä¸åŒé…ç½®
export default [buildIndexOptions, buildUtilOptions];
```
4. outputé…ç½®
``` javascript
output: {
  // äº§ç‰©è¾“å‡ºç›®å½•
  dir: path.resolve(__dirname, 'dist'),
  // ä»¥ä¸‹ä¸‰ä¸ªé…ç½®é¡¹éƒ½å¯ä»¥ä½¿ç”¨è¿™äº›å ä½ç¬¦:
  // 1. [name]: å»é™¤æ–‡ä»¶åç¼€åçš„æ–‡ä»¶å
  // 2. [hash]: æ ¹æ®æ–‡ä»¶åå’Œæ–‡ä»¶å†…å®¹ç”Ÿæˆçš„ hash å€¼
  // 3. [format]: äº§ç‰©æ¨¡å—æ ¼å¼ï¼Œå¦‚ esã€cjs
  // 4. [extname]: äº§ç‰©åç¼€å(å¸¦`.`)
  // å…¥å£æ¨¡å—çš„è¾“å‡ºæ–‡ä»¶å
  entryFileNames: `[name].js`,
  // éå…¥å£æ¨¡å—(å¦‚åŠ¨æ€ import)çš„è¾“å‡ºæ–‡ä»¶å
  chunkFileNames: 'chunk-[hash].js',
  // é™æ€èµ„æºæ–‡ä»¶è¾“å‡ºæ–‡ä»¶å
  assetFileNames: 'assets/[name]-[hash][extname]',
  // äº§ç‰©è¾“å‡ºæ ¼å¼ï¼ŒåŒ…æ‹¬`amd`ã€`cjs`ã€`es`ã€`iife`ã€`umd`ã€`system`
  format: 'cjs',
  // æ˜¯å¦ç”Ÿæˆ sourcemap æ–‡ä»¶
  sourcemap: true,
  // å¦‚æœæ˜¯æ‰“åŒ…å‡º iife/umd æ ¼å¼ï¼Œéœ€è¦å¯¹å¤–æš´éœ²å‡ºä¸€ä¸ªå…¨å±€å˜é‡ï¼Œé€šè¿‡ name é…ç½®å˜é‡å
  name: 'MyBundle',
  // å…¨å±€å˜é‡å£°æ˜
  globals: {
    // é¡¹ç›®ä¸­å¯ä»¥ç›´æ¥ç”¨`$`ä»£æ›¿`jquery`
    jquery: '$'
  }
}
```

5. external å¿½ç•¥æ‰“åŒ…ï¼Œå¤–éƒ¨æ„å»º
6. æ¥å…¥æ’ä»¶
- `@rollup/plugin-node-resolve`æ˜¯ä¸ºäº†å…è®¸æˆ‘ä»¬åŠ è½½ç¬¬ä¸‰æ–¹ä¾èµ–ï¼Œå¦åˆ™åƒimport React from 'react' çš„ä¾èµ–å¯¼å…¥è¯­å¥å°†ä¸ä¼šè¢« Rollup è¯†åˆ«ã€‚
- `@rollup/plugin-commonjs` çš„ä½œç”¨æ˜¯å°† CommonJS æ ¼å¼çš„ä»£ç è½¬æ¢ä¸º ESM æ ¼å¼
- `@rollup/plugin-babel`åŠ`@babel/preset-react` ä½¿ç”¨babelè¿›è¡Œjsxä»£ç è¯­æ³•è½¬ä¹‰
- `@rollup/plugin-json` æ”¯æŒ.jsonçš„åŠ è½½ï¼Œå¹¶é…åˆrollupçš„Tree Shakingæœºåˆ¶å»æ‰æœªä½¿ç”¨çš„éƒ¨åˆ†ï¼Œè¿›è¡ŒæŒ‰éœ€æ‰“åŒ…ã€‚
- `@rollup/plugin-babel` åœ¨ Rollup ä¸­ä½¿ç”¨ Babel è¿›è¡Œ JS ä»£ç çš„è¯­æ³•è½¬è¯‘ã€‚
- `@rollup/plugin-typescript` æ”¯æŒä½¿ç”¨ TypeScript å¼€å‘ã€‚
- `@rollup/plugin-alias` æ”¯æŒåˆ«åé…ç½®ã€‚
- `@rollup/plugin-replace` åœ¨ Rollup è¿›è¡Œå˜é‡å­—ç¬¦ä¸²çš„æ›¿æ¢ã€‚
- `rollup-plugin-visualizer` å¯¹ Rollup æ‰“åŒ…äº§ç‰©è¿›è¡Œåˆ†æï¼Œè‡ªåŠ¨ç”Ÿæˆäº§ç‰©ä½“ç§¯å¯è§†åŒ–åˆ†æå›¾ã€‚
  
7. é€šè¿‡jsAPIå®ç°æ‰“åŒ…ï¼ˆbuildã€watchï¼‰
- é€šè¿‡ rollup.rollupæ–¹æ³•ï¼Œä¼ å…¥ inputOptionsï¼Œç”Ÿæˆ bundle å¯¹è±¡ï¼›
- è°ƒç”¨ bundle å¯¹è±¡çš„ generate å’Œ write æ–¹æ³•ï¼Œä¼ å…¥outputOptionsï¼Œåˆ†åˆ«å®Œæˆäº§ç‰©å’Œç”Ÿæˆå’Œç£ç›˜å†™å…¥ã€‚
- è°ƒç”¨ bundle å¯¹è±¡çš„ close æ–¹æ³•æ¥ç»“æŸæ‰“åŒ…ã€‚

8. æ‰“åŒ…æµç¨‹ã€æ’ä»¶æœºåˆ¶
- Input - Build - Output
- Buildé˜¶æ®µä¸»è¦åˆå§‹åŒ–ASTä»¥åŠå„ä¸ªæ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»
- ç»è¿‡Buildçš„bundleå…¶å®å¹¶æ²¡æœ‰è¿›è¡Œæ¨¡å—çš„æ‰“åŒ…ï¼Œå…¶ä¸»è¦ç”¨äºå­˜å‚¨æ¨¡å—å†…å®¹ä»¥åŠä¾èµ–å…³ç³»ï¼ŒåŒæ—¶æš´éœ²generateå’Œwriteæ–¹æ³•ï¼Œæ¥è¿›å…¥åˆ°Outputé˜¶æ®µ

9. æ’ä»¶å¸¸ç”¨HookåŠå…¶æ‰§è¡Œæ–¹å¼
- æ‰§è¡Œæ–¹å¼ï¼šåŒæ­¥syncã€å¼‚æ­¥asyncã€å¹¶è¡Œparallelã€ä¸²è¡Œsequentialã€firstä¼˜å…ˆ
- è·¯å¾„è§£æresolveIdï¼Œå¼‚æ­¥ä¼˜å…ˆasync+firstï¼Œä¾‹å¦‚alias
- åŠ è½½æ¨¡å—loadï¼Œå¼‚æ­¥ä¼˜å…ˆasync+firstï¼Œä¾‹å¦‚image
- ä»£ç è½¬æ¢transformï¼Œå¼‚æ­¥ä¸²è¡Œasync+sequentialï¼Œå¯¹åŠ è½½åçš„æ¨¡å—å†…å®¹è‡ªå®šä¹‰è½¬æ¢ï¼Œä¾‹å¦‚replace
- chunkçº§ä»£ç ä¿®æ”¹chunkRenderï¼Œåœ¨replaceæ’ä»¶ä¸­ï¼Œåœ¨è¿™ä¸ªhookä¸­ä¹Ÿè¿›è¡Œäº†æ›¿æ¢ï¼Œå› ä¸ºåœ¨transformä¸­ä¸²è¡Œæ‰§è¡Œï¼Œåç»­æ’ä»¶ä¹Ÿå¯èƒ½è¿›è¡Œäº†æ¨¡å—å†…å®¹çš„æ›¿æ¢ï¼Œè¿›è€Œå‡ºç°ç¬¦åˆæ›¿æ¢è§„åˆ™çš„å­—ç¬¦ä¸²
- äº§ç‰©ç”Ÿæˆæœ€åä¸€æ­¥generateBundleï¼Œå¼‚æ­¥ä¸²è¡Œï¼Œç”¨äºåˆ é™¤ä¸€äº›æ— ç”¨çš„chunkæˆ–é™æ€èµ„æºï¼Œä¾‹å¦‚html

##### Viteæ’ä»¶å¼€å‘
1. å¼€å‘é˜¶æ®µï¼ŒViteä¼šå®ç°ä¸€ä¸ªplugin Containerï¼ˆMock Rollupï¼‰è°ƒç”¨ä¸€ç³»åˆ—é’©å­ 
- æœåŠ¡å™¨å¯åŠ¨é˜¶æ®µ: optionså’ŒbuildStarté’©å­ä¼šåœ¨æœåŠ¡å¯åŠ¨æ—¶è¢«è°ƒç”¨ã€‚
- è¯·æ±‚å“åº”é˜¶æ®µ: å½“æµè§ˆå™¨å‘èµ·è¯·æ±‚æ—¶ï¼ŒVite å†…éƒ¨ä¾æ¬¡è°ƒç”¨resolveIdã€loadå’Œtransformé’©å­ã€‚
- æœåŠ¡å™¨å…³é—­é˜¶æ®µ: Vite ä¼šä¾æ¬¡æ‰§è¡ŒbuildEndå’ŒcloseBundleé’©å­ã€‚

2. Viteç‹¬æœ‰Hook
- configï¼Œè·å–vite.config.jsä¸­çš„é…ç½®å¯¹è±¡å¹¶è¿”å›ä¸€ä¸ªæ–°çš„configå¯¹è±¡
- configResolvedï¼Œè·å–æœ€ç»ˆconfigé…ç½®å¯¹è±¡
- configureServerï¼Œç”¨æ¥è·å– Vite Dev Server å®ä¾‹ï¼Œæ·»åŠ ä¸­é—´ä»¶ã€‚
- transformIndexHtmlï¼Œç”¨æ¥è½¬æ¢ HTML çš„å†…å®¹ã€‚
- handleHotUpdateï¼Œç”¨æ¥è¿›è¡Œçƒ­æ›´æ–°æ¨¡å—çš„è¿‡æ»¤ï¼Œæˆ–è€…è¿›è¡Œè‡ªå®šä¹‰çš„çƒ­æ›´æ–°å¤„ç†

3. å¼€å‘è°ƒè¯•æŠ€å·§ï¼šè£…ä¸Švite-plugin-inspectæ’ä»¶ï¼Œåœ¨è°ƒè¯•é¡µé¢æŸ¥çœ‹å„ä¸ªæ¨¡å—çš„è¾“å‡ºå†…å®¹

##### Vite HMRçƒ­æ›´æ–°åŸç† - å®ç°æ¨¡å—å±€éƒ¨æ›´æ–°+çŠ¶æ€ä¿å­˜
1. import.meta.hot.accept
- æ¥å—è‡ªèº«æ¨¡å—çš„æ›´æ–°
- æ¥å—æŸä¸ªå­æ¨¡å—çš„æ›´æ–°
- æ¥å—å¤šä¸ªå­æ¨¡å—çš„æ›´æ–°
  
2. import.meta.hot.dispose
3. import.meta.hot.data

##### Vite æ‹†åŒ…
1. è‡ªå®šä¹‰æ‹†åŒ…å®¹æ˜“å‡ºç°æ¨¡å—å¾ªç¯ä¾èµ–é—®é¢˜ï¼Œä¾èµ–æ²¡æ‹†å¹²å‡€ï¼Œreactçš„ç›¸å…³ä¾èµ–åœ¨indexä¸­ï¼Œindexåˆä¾èµ–reactï¼Œä¸€é”®è§£å†³æ–¹æ¡ˆ`vite-plugin-chunk-split`
2. å¾ªç¯ä¾èµ–ï¼ˆcjsã€mjsï¼‰
- cjsçš„åŒ…åœ¨ç¬¬ä¸€æ¬¡è¢«æ‰§è¡Œrequireçš„æ—¶å€™ä¼šç”Ÿæˆä¸€ä¸ªmodule.exportsçš„å¯¹è±¡ï¼Œæ˜¯å…¶å†…å®¹çš„æ‹·è´ï¼Œåç»­requireä¼šè¿”å›ä»–çš„exportsç¼“å­˜ï¼Œå‡ºç°å¾ªç¯ä¾èµ–æ—¶ä¹‹å‰çš„ç¬¬ä¸€ä¸ªåŒ…æ²¡æœ‰æ‰§è¡Œå®Œï¼Œå…¶æœªæ‰§è¡Œåˆ°çš„è¾“å‡ºè¯­å¥çš„å¯¼å‡ºå˜é‡ä¸ºundefined
- mjsçš„åŒ…é™¤äº†å¯¼å‡ºå‡½æ•°å£°æ˜çš„å‡½æ•°ä¹‹å¤–çš„å¯¼å‡ºä¹Ÿæ˜¯undefined


